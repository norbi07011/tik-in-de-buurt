<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Powiadomie≈Ñ i Chatu - Tik in de Buurt</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; margin-bottom: 15px; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .panel-spaced {
            margin-top: 20px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #dc2626; }
        .info { background: #dbeafe; color: #1d4ed8; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .notification-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üîî Test Systemu Powiadomie≈Ñ i Chatu</h1>
    <div id="status" class="status info">≈ÅƒÖczenie z serwerem...</div>
    
    <div class="container">
        <!-- Panel powiadomie≈Ñ -->
        <div class="panel">
            <h2>üì¨ System Powiadomie≈Ñ</h2>
            
            <h3>Stw√≥rz powiadomienie</h3>
            <input type="text" id="notif-user" placeholder="User ID (np. test-user)" value="test-user">
            <select id="notif-type" aria-label="Select notification type">
                <option value="like">Like</option>
                <option value="comment">Comment</option>
                <option value="follow">Follow</option>
                <option value="message">Message</option>
                <option value="system">System</option>
            </select>
            <input type="text" id="notif-title" placeholder="Tytu≈Ç powiadomienia">
            <input type="text" id="notif-content" placeholder="Tre≈õƒá powiadomienia">
            <button onclick="createNotification()">üì§ Wy≈õlij Powiadomienie</button>
            
            <h3>Moje powiadomienia</h3>
            <button onclick="getNotifications()">üîÑ Od≈õwie≈º</button>
            <button onclick="markAllRead()">‚úÖ Oznacz wszystkie jako przeczytane</button>
            <div id="notifications-list"></div>
        </div>

        <!-- Panel chatu -->
        <div class="panel">
            <h2>üí¨ System Chatu</h2>
            
            <h3>Rozpocznij rozmowƒô</h3>
            <input type="text" id="chat-participants" placeholder="Uczestnicy (oddziel przecinkami)" value="test-user,user2">
            <input type="text" id="chat-title" placeholder="Tytu≈Ç rozmowy">
            <button onclick="createConversation()">üÜï Stw√≥rz Rozmowƒô</button>
            
            <h3>Wy≈õlij wiadomo≈õƒá</h3>
            <input type="text" id="message-conv-id" placeholder="ID Rozmowy">
            <input type="text" id="message-content" placeholder="Tre≈õƒá wiadomo≈õci">
            <button onclick="sendMessage()">üì® Wy≈õlij Wiadomo≈õƒá</button>
            
            <h3>Aktywne rozmowy</h3>
            <button onclick="getConversations()">üîÑ Od≈õwie≈º Rozmowy</button>
            <div id="conversations-list"></div>
        </div>
    </div>

    <!-- Logi -->
    <div class="panel panel-spaced">
        <h2>üìã Logi Systemowe</h2>
        <button onclick="clearLogs()">üßπ Wyczy≈õƒá Logi</button>
        <div id="logs" class="log"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Po≈ÇƒÖczenie z Socket.IO
        const socket = io('http://localhost:5000');
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');

        // Mock auth token (w prawdziwej aplikacji to by≈Çby prawdziwy JWT)
        const mockToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ0ZXN0LXVzZXIiLCJlbWFpbCI6InRlc3RAdGVzdC5jb20ifQ.mock';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsEl.innerHTML += `[${timestamp}] ${message}<br>`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        // Socket.IO Event Handlers
        socket.on('connect', () => {
            statusEl.className = 'status success';
            statusEl.textContent = '‚úÖ Po≈ÇƒÖczono z serwerem Socket.IO';
            log('‚úÖ Po≈ÇƒÖczono z Socket.IO');
            
            // Authenticate with mock token
            socket.emit('authenticate', mockToken);
        });

        socket.on('authenticated', () => {
            log('üîê Zalogowano pomy≈õlnie');
            statusEl.textContent = '‚úÖ Po≈ÇƒÖczono i zalogowano';
        });

        socket.on('disconnect', () => {
            statusEl.className = 'status error';
            statusEl.textContent = '‚ùå Roz≈ÇƒÖczono z serwerem';
            log('‚ùå Roz≈ÇƒÖczono z Socket.IO');
        });

        socket.on('notification', (data) => {
            log(`üîî Nowe powiadomienie: ${data.title}`);
            getNotifications(); // Od≈õwie≈º listƒô
        });

        socket.on('message', (data) => {
            log(`üí¨ Nowa wiadomo≈õƒá od ${data.sender}: ${data.content}`);
            getConversations(); // Od≈õwie≈º rozmowy
        });

        socket.on('error', (error) => {
            log(`‚ùå B≈ÇƒÖd: ${error.message}`);
        });

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${mockToken}`
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`http://localhost:5000${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API Error');
                }
                
                return data;
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`);
                throw error;
            }
        }

        // Notification Functions
        async function createNotification() {
            const userId = document.getElementById('notif-user').value;
            const type = document.getElementById('notif-type').value;
            const title = document.getElementById('notif-title').value;
            const content = document.getElementById('notif-content').value;
            
            if (!title || !content) {
                alert('Wype≈Çnij tytu≈Ç i tre≈õƒá powiadomienia');
                return;
            }
            
            try {
                const result = await apiCall('/api/notifications', 'POST', {
                    userId,
                    type,
                    title,
                    content,
                    data: { source: 'test-panel' }
                });
                
                log(`‚úÖ Powiadomienie utworzone: ${result.notification._id}`);
                
                // Wyczy≈õƒá formularz
                document.getElementById('notif-title').value = '';
                document.getElementById('notif-content').value = '';
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd tworzenia powiadomienia: ${error.message}`);
            }
        }

        async function getNotifications() {
            try {
                const result = await apiCall('/api/notifications');
                const listEl = document.getElementById('notifications-list');
                
                if (result.notifications.length === 0) {
                    listEl.innerHTML = '<div class="notification-item">Brak powiadomie≈Ñ</div>';
                    return;
                }
                
                listEl.innerHTML = result.notifications.map(notif => `
                    <div class="notification-item" style="${notif.read ? 'opacity: 0.6;' : ''}">
                        <strong>${notif.title}</strong> (${notif.type})
                        <br>${notif.content}
                        <br><small>${new Date(notif.createdAt).toLocaleString()}</small>
                        ${!notif.read ? `<button onclick="markAsRead('${notif._id}')">‚úÖ Przeczytaj</button>` : ''}
                        <button onclick="deleteNotification('${notif._id}')">üóëÔ∏è Usu≈Ñ</button>
                    </div>
                `).join('');
                
                log(`üìã Za≈Çadowano ${result.notifications.length} powiadomie≈Ñ`);
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd pobierania powiadomie≈Ñ: ${error.message}`);
            }
        }

        async function markAsRead(notificationId) {
            try {
                await apiCall(`/api/notifications/${notificationId}/read`, 'PUT');
                log(`‚úÖ Oznaczono jako przeczytane: ${notificationId}`);
                getNotifications();
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd oznaczania jako przeczytane: ${error.message}`);
            }
        }

        async function markAllRead() {
            try {
                await apiCall('/api/notifications/mark-all-read', 'PUT');
                log('‚úÖ Wszystkie powiadomienia oznaczone jako przeczytane');
                getNotifications();
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd oznaczania wszystkich jako przeczytane: ${error.message}`);
            }
        }

        async function deleteNotification(notificationId) {
            try {
                await apiCall(`/api/notifications/${notificationId}`, 'DELETE');
                log(`üóëÔ∏è Usuniƒôto powiadomienie: ${notificationId}`);
                getNotifications();
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd usuwania powiadomienia: ${error.message}`);
            }
        }

        // Chat Functions
        async function createConversation() {
            const participants = document.getElementById('chat-participants').value.split(',').map(p => p.trim());
            const title = document.getElementById('chat-title').value;
            
            if (participants.length < 1) {
                alert('Dodaj co najmniej jednego uczestnika');
                return;
            }
            
            try {
                const result = await apiCall('/api/chat/conversations', 'POST', {
                    participants,
                    title: title || undefined
                });
                
                log(`‚úÖ Rozmowa utworzona: ${result.conversation._id}`);
                document.getElementById('message-conv-id').value = result.conversation._id;
                
                // Wyczy≈õƒá formularz
                document.getElementById('chat-title').value = '';
                getConversations();
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd tworzenia rozmowy: ${error.message}`);
            }
        }

        async function sendMessage() {
            const conversationId = document.getElementById('message-conv-id').value;
            const content = document.getElementById('message-content').value;
            
            if (!conversationId || !content) {
                alert('Wype≈Çnij ID rozmowy i tre≈õƒá wiadomo≈õci');
                return;
            }
            
            try {
                const result = await apiCall(`/api/chat/conversations/${conversationId}/messages`, 'POST', {
                    content,
                    type: 'text'
                });
                
                log(`‚úÖ Wiadomo≈õƒá wys≈Çana: ${result.message._id}`);
                
                // Wyczy≈õƒá tre≈õƒá
                document.getElementById('message-content').value = '';
                getConversations();
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd wysy≈Çania wiadomo≈õci: ${error.message}`);
            }
        }

        async function getConversations() {
            try {
                const result = await apiCall('/api/chat/conversations');
                const listEl = document.getElementById('conversations-list');
                
                if (result.conversations.length === 0) {
                    listEl.innerHTML = '<div class="notification-item">Brak rozm√≥w</div>';
                    return;
                }
                
                listEl.innerHTML = result.conversations.map(conv => `
                    <div class="notification-item">
                        <strong>${conv.title || 'Rozmowa bez tytu≈Çu'}</strong>
                        <br>ID: ${conv._id}
                        <br>Uczestnicy: ${conv.participants.join(', ')}
                        <br><small>Utworzono: ${new Date(conv.createdAt).toLocaleString()}</small>
                        <br><button onclick="getMessages('${conv._id}')">üìã Zobacz wiadomo≈õci</button>
                    </div>
                `).join('');
                
                log(`üí¨ Za≈Çadowano ${result.conversations.length} rozm√≥w`);
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd pobierania rozm√≥w: ${error.message}`);
            }
        }

        async function getMessages(conversationId) {
            try {
                const result = await apiCall(`/api/chat/conversations/${conversationId}/messages`);
                
                if (result.messages.length === 0) {
                    log(`üì≠ Brak wiadomo≈õci w rozmowie ${conversationId}`);
                    return;
                }
                
                log(`üì¨ Wiadomo≈õci w rozmowie ${conversationId}:`);
                result.messages.forEach(msg => {
                    log(`  üë§ ${msg.sender}: ${msg.content} (${new Date(msg.createdAt).toLocaleTimeString()})`);
                });
            } catch (error) {
                log(`‚ùå B≈ÇƒÖd pobierania wiadomo≈õci: ${error.message}`);
            }
        }

        function clearLogs() {
            logsEl.innerHTML = '';
        }

        // Auto-refresh notifications every 30 seconds
        setInterval(getNotifications, 30000);
        
        // Initial load
        setTimeout(() => {
            getNotifications();
            getConversations();
        }, 1000);
    </script>
</body>
</html>