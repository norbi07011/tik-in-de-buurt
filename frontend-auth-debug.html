<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Auth Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Frontend Authentication Debug</h1>
    
    <div class="test-section">
        <h2>1. Environment Check</h2>
        <button onclick="checkEnvironment()">Check Environment Variables</button>
        <div id="envResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. API Configuration Test</h2>
        <button onclick="testAPIConfig()">Test API Config</button>
        <div id="apiConfigResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Direct API Call Test</h2>
        <button onclick="testDirectAPI()">Test Direct API Call</button>
        <div id="directAPIResult"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Simulate Frontend Auth Flow</h2>
        <button onclick="simulateAuthFlow()">Simulate AuthContext Login</button>
        <div id="authFlowResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. LocalStorage Test</h2>
        <button onclick="testLocalStorage()">Test Token Storage</button>
        <div id="localStorageResult"></div>
    </div>
    
    <div class="test-section">
        <h2>6. CORS Test</h2>
        <button onclick="testCORS()">Test CORS Configuration</button>
        <div id="corsResult"></div>
    </div>

    <script>
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${content}</div>`;
        }

        function checkEnvironment() {
            const config = {
                VITE_API_URL: import.meta.env.VITE_API_URL,
                VITE_USE_MOCK_API: import.meta.env.VITE_USE_MOCK_API,
                MODE: import.meta.env.MODE,
                DEV: import.meta.env.DEV,
                PROD: import.meta.env.PROD
            };
            
            showResult('envResult', `
                <h3>Environment Variables:</h3>
                <pre>${JSON.stringify(config, null, 2)}</pre>
                <p><strong>API Base URL:</strong> ${import.meta.env.VITE_API_URL || 'http://localhost:8080/api'}</p>
                <p><strong>Mock API:</strong> ${import.meta.env.VITE_USE_MOCK_API === 'true' ? 'YES (Mock Mode)' : 'NO (Real API)'}</p>
            `, 'info');
        }

        async function testAPIConfig() {
            try {
                // Simulate the same config that api.ts uses
                const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8080/api';
                const USE_MOCK_API = import.meta.env.VITE_USE_MOCK_API === 'true';
                
                showResult('apiConfigResult', `
                    <h3>API Configuration:</h3>
                    <p><strong>Base URL:</strong> ${API_BASE_URL}</p>
                    <p><strong>Use Mock:</strong> ${USE_MOCK_API}</p>
                    <p><strong>Login URL:</strong> ${API_BASE_URL}/auth/login</p>
                    <p><strong>Status:</strong> Configuration loaded successfully</p>
                `, 'success');
            } catch (error) {
                showResult('apiConfigResult', `<strong>Error:</strong> ${error.message}`, 'error');
            }
        }

        async function testDirectAPI() {
            try {
                const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8080/api';
                
                // Test health first
                const healthResponse = await fetch('http://localhost:8080/health');
                const healthData = await healthResponse.json();
                
                // Test auth endpoint
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`HTTP ${loginResponse.status}: ${loginResponse.statusText}`);
                }
                
                const loginData = await loginResponse.json();
                
                showResult('directAPIResult', `
                    <h3>Direct API Test Results:</h3>
                    <p><strong>‚úÖ Health Check:</strong> ${healthData.status}</p>
                    <p><strong>‚úÖ Database:</strong> ${healthData.database?.connected ? 'Connected' : 'Failed'}</p>
                    <p><strong>‚úÖ Login API:</strong> Success</p>
                    <p><strong>User:</strong> ${loginData.user.name} (${loginData.user.email})</p>
                    <p><strong>Token:</strong> ${loginData.token ? 'Received' : 'Missing'}</p>
                `, 'success');
                
            } catch (error) {
                showResult('directAPIResult', `<strong>‚ùå API Test Failed:</strong> ${error.message}`, 'error');
            }
        }

        async function simulateAuthFlow() {
            try {
                // Simulate exactly what AuthContext does
                const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8080/api';
                const USE_MOCK_API = import.meta.env.VITE_USE_MOCK_API === 'true';
                
                if (USE_MOCK_API) {
                    showResult('authFlowResult', `<strong>‚ö†Ô∏è Mock API Mode:</strong> Cannot test real auth flow`, 'error');
                    return;
                }
                
                // Step 1: Login API call
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Step 2: Store tokens (like AuthContext does)
                localStorage.setItem('auth-token', data.token);
                localStorage.setItem('auth-user', JSON.stringify(data.user));
                
                // Step 3: Verify token (like AuthContext does)
                const verifyResponse = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${data.token}`
                    }
                });
                
                if (!verifyResponse.ok) {
                    throw new Error(`Token verification failed: ${verifyResponse.status}`);
                }
                
                const verifyData = await verifyResponse.json();
                
                showResult('authFlowResult', `
                    <h3>‚úÖ Auth Flow Simulation Success:</h3>
                    <p><strong>1. Login:</strong> ‚úÖ Success</p>
                    <p><strong>2. Token Storage:</strong> ‚úÖ Stored</p>
                    <p><strong>3. Token Verification:</strong> ‚úÖ Valid</p>
                    <p><strong>User:</strong> ${verifyData.user.name} (${verifyData.user.email})</p>
                    <p><strong>üéâ AuthContext should work perfectly!</strong></p>
                `, 'success');
                
            } catch (error) {
                showResult('authFlowResult', `<strong>‚ùå Auth Flow Failed:</strong> ${error.message}`, 'error');
            }
        }

        function testLocalStorage() {
            try {
                // Clear existing
                localStorage.removeItem('test-token');
                localStorage.removeItem('test-user');
                
                // Test storage
                const testToken = 'test-jwt-token-12345';
                const testUser = { id: 1, name: 'Test User', email: 'test@example.com' };
                
                localStorage.setItem('test-token', testToken);
                localStorage.setItem('test-user', JSON.stringify(testUser));
                
                // Test retrieval
                const retrievedToken = localStorage.getItem('test-token');
                const retrievedUser = JSON.parse(localStorage.getItem('test-user') || '{}');
                
                // Test auth-token format (used by app)
                localStorage.setItem('auth-token', testToken);
                localStorage.setItem('auth-user', JSON.stringify(testUser));
                
                const authToken = localStorage.getItem('auth-token');
                const authUser = JSON.parse(localStorage.getItem('auth-user') || '{}');
                
                showResult('localStorageResult', `
                    <h3>‚úÖ LocalStorage Test Results:</h3>
                    <p><strong>Storage:</strong> ‚úÖ Working</p>
                    <p><strong>Retrieval:</strong> ‚úÖ Working</p>
                    <p><strong>JSON Parsing:</strong> ‚úÖ Working</p>
                    <p><strong>Auth Token Storage:</strong> ${authToken ? '‚úÖ Working' : '‚ùå Failed'}</p>
                    <p><strong>Auth User Storage:</strong> ${authUser.name ? '‚úÖ Working' : '‚ùå Failed'}</p>
                `, 'success');
                
                // Cleanup
                localStorage.removeItem('test-token');
                localStorage.removeItem('test-user');
                
            } catch (error) {
                showResult('localStorageResult', `<strong>‚ùå LocalStorage Test Failed:</strong> ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            try {
                // Test preflight request
                const corsTestResponse = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': corsTestResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': corsTestResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': corsTestResponse.headers.get('Access-Control-Allow-Headers'),
                };
                
                // Test actual CORS with real request
                const testResponse = await fetch('http://localhost:8080/health', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const corsWorking = testResponse.ok;
                
                showResult('corsResult', `
                    <h3>CORS Test Results:</h3>
                    <p><strong>Preflight Response:</strong> ${corsTestResponse.status}</p>
                    <p><strong>Allow Origin:</strong> ${corsHeaders['Access-Control-Allow-Origin'] || 'Not set'}</p>
                    <p><strong>Allow Methods:</strong> ${corsHeaders['Access-Control-Allow-Methods'] || 'Not set'}</p>
                    <p><strong>Allow Headers:</strong> ${corsHeaders['Access-Control-Allow-Headers'] || 'Not set'}</p>
                    <p><strong>Cross-Origin Request:</strong> ${corsWorking ? '‚úÖ Working' : '‚ùå Blocked'}</p>
                    <p><strong>Current Origin:</strong> ${window.location.origin}</p>
                `, corsWorking ? 'success' : 'error');
                
            } catch (error) {
                showResult('corsResult', `<strong>‚ùå CORS Test Failed:</strong> ${error.message}`, 'error');
            }
        }

        // Auto-run environment check
        window.onload = () => {
            checkEnvironment();
        };
    </script>
</body>
</html>